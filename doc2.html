<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Itens de Conhecimento</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-blue-bg': '#0a192f', /* Mais escuro */
                        'card-bg': '#112240', /* Cartão mais claro */
                        'primary-blue': '#64ffda', /* Cor de destaque (neon/aqua) */
                        'input-bg': '#172a45', /* Cor de fundo do input */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
    </style>
</head>

<body class="bg-dark-blue-bg text-gray-100 flex items-start justify-center p-4">

    <div class="w-full max-w-4xl bg-card-bg shadow-2xl p-8 md:p-10 rounded-xl space-y-8 mt-8 border border-primary-blue/20">
        
        <header class="flex justify-between items-center border-b border-primary-blue/30 pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white flex items-center">
                <i class="fas fa-list-ul text-primary-blue mr-3"></i>
                Itens de Conhecimento Salvos
            </h1>
            <a href="cadastro.html" class="py-2 px-4 text-primary-blue border border-primary-blue hover:bg-primary-blue/10 font-semibold rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-plus-circle mr-2"></i>
                Novo Cadastro
            </a>
        </header>

        <!-- Mensagens de Feedback (para erros de carregamento) -->
        <div id="messageBox" class="p-3 text-center rounded-lg hidden font-semibold text-sm border-2" role="alert"></div>

        <div id="items-list-container">
            <h2 class="text-xl font-bold text-gray-300 mb-4">Arquivos e Artigos</h2>
            <ul id="knowledge-items-list" class="space-y-3">
                <li class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Carregando itens...</li>
            </ul>
        </div>
    </div>

    <script>
        // Rota corrigida para a API de Documentação
        const API_ENDPOINT = '/api/documentacao';
        const ITEMS_LIST = document.getElementById('knowledge-items-list');
        const MESSAGE_BOX = document.getElementById('messageBox');
        
        // Função para exibir mensagens na caixa de feedback
        function showMessage(message, type = 'success') {
            MESSAGE_BOX.textContent = message;
            MESSAGE_BOX.classList.remove('hidden', 'bg-red-500/10', 'bg-green-500/10', 'text-red-400', 'text-green-400', 'border-red-500', 'border-green-500', 'bg-primary-blue/10', 'text-primary-blue', 'border-primary-blue');
            
            if (type === 'success') {
                MESSAGE_BOX.classList.add('bg-primary-blue/10', 'text-primary-blue', 'border', 'border-primary-blue');
            } else if (type === 'error') {
                MESSAGE_BOX.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500');
            }
        }

        // Função de Download (acessível globalmente)
        window.downloadFile = function(itemId) {
            // Usa a rota GET de download que serve o Buffer
            window.location.href = `${API_ENDPOINT}/download/${itemId}`;
        }
        
        // Função para carregar e renderizar a lista de itens
        async function loadKnowledgeItems() {
            ITEMS_LIST.innerHTML = '<li class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Carregando itens...</li>';
            
            try {
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) throw new Error('Falha ao carregar itens');
                
                const items = await response.json();
                ITEMS_LIST.innerHTML = ''; // Limpa a lista
                
                if (items.length === 0) {
                    ITEMS_LIST.innerHTML = '<li class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Nenhum item de conhecimento cadastrado.</li>';
                    return;
                }

                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 bg-input-bg rounded-lg flex justify-between items-center flex-wrap';
                    
                    let contentInfo;
                    
                    // CRUCIAL: Agora todos os tipos, incluindo TEXTO, geram o botão de Download.
                    const isDownloadable = (item.tipoConteudo === 'TEXTO' || item.tipoConteudo === 'PDF' || item.tipoConteudo === 'HTML');
                    
                    let actionButton = '';

                    if (item.tipoConteudo === 'TEXTO') {
                        // Exibe um resumo do texto
                        const resumo = item.texto ? item.texto.substring(0, 80).replace(/\n/g, ' ') + '...' : 'Sem conteúdo de texto.';
                        contentInfo = `<span class="text-sm text-gray-300 mt-1 md:mt-0 w-full md:w-auto flex items-center"><i class="fas fa-terminal mr-2 text-primary-blue"></i>Texto: ${resumo}</span>`;
                    } else {
                        // Para arquivos, exibe o nome do arquivo
                        const icon = item.tipoConteudo === 'PDF' ? 'fas fa-file-pdf' : 'fas fa-code';
                        const fileName = item.nomeArquivo || 'Nome Indisponível';
                        contentInfo = `<span class="text-sm text-gray-300 mt-1 md:mt-0 w-full md:w-auto flex items-center"><i class="${icon} mr-2 text-primary-blue"></i>Arquivo: ${fileName}</span>`;
                    }
                    
                    // Gera o botão de download se for baixável
                    if (isDownloadable) {
                        actionButton = `
                            <button onclick="downloadFile('${item._id}')" 
                                class="mt-2 md:mt-0 py-1 px-3 bg-primary-blue hover:bg-green-600 text-dark-blue-bg text-xs font-bold rounded transition duration-200 flex items-center">
                                <i class="fas fa-download mr-1"></i> Download
                            </button>
                        `;
                    }

                    listItem.innerHTML = `
                        <div class="w-full md:w-auto flex-grow">
                            <p class="font-semibold text-white">${item.titulo} <span class="text-gray-400 text-xs ml-2">(${item.estado})</span></p>
                            ${contentInfo}
                        </div>
                        ${actionButton}
                    `;
                    ITEMS_LIST.appendChild(listItem);
                });

            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                showMessage('Erro ao carregar dados do servidor. Verifique o backend.', 'error');
                ITEMS_LIST.innerHTML = '';
            }
        }

        // Carrega os itens ao iniciar a página
        window.onload = loadKnowledgeItems;

    </script>
</body>

</html>
