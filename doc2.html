<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Itens de Conhecimento</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-blue-bg': '#0b172a',
                        'card-bg': '#1a273b',
                        'primary-blue': '#4c7cff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
    </style>
</head>

<body class="bg-dark-blue-bg text-gray-100 flex items-start justify-center p-4">

    <div class="w-full max-w-4xl bg-card-bg shadow-2xl p-8 md:p-10 rounded-xl space-y-8 mt-8">
        
        <header class="flex justify-between items-center border-b border-primary-blue/30 pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white">
                Itens de Conhecimento Salvos
            </h1>
            <a href="cadastro.html" class="py-2 px-4 bg-primary-blue hover:bg-blue-600 text-white font-semibold rounded-lg transition duration-300">
                Novo Cadastro
            </a>
        </header>

        <!-- Mensagens de Feedback (para erros de carregamento) -->
        <div id="messageBox" class="p-3 text-center rounded-lg hidden font-semibold" role="alert"></div>

        <div id="items-list-container">
            <h2 class="text-xl font-bold text-gray-300 mb-4">Arquivos e Artigos</h2>
            <ul id="knowledge-items-list" class="space-y-3">
                <!-- Itens serão carregados aqui pelo JavaScript -->
                <li class="text-gray-400 text-sm">Carregando itens...</li>
            </ul>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/documentacao';
        const ITEMS_LIST = document.getElementById('knowledge-items-list');
        const MESSAGE_BOX = document.getElementById('messageBox');
        
        // Função para exibir mensagens na caixa de feedback
        function showMessage(message, type = 'success') {
            MESSAGE_BOX.textContent = message;
            MESSAGE_BOX.classList.remove('hidden', 'bg-red-500/10', 'bg-green-500/10', 'text-red-400', 'text-green-400', 'border-red-500', 'border-green-500');
            
            if (type === 'success') {
                MESSAGE_BOX.classList.add('bg-green-500/10', 'text-green-400', 'border', 'border-green-500');
            } else if (type === 'error') {
                MESSAGE_BOX.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500');
            }
        }

        // Função de Download (acessível globalmente)
        window.downloadFile = function(itemId) {
            // Usa a rota GET de download implementada no backend (server_additions_v2.js)
            window.location.href = `${API_ENDPOINT}/download/${itemId}`;
        }
        
        // Função para carregar e renderizar a lista de itens
        async function loadKnowledgeItems() {
            ITEMS_LIST.innerHTML = '<li class="text-gray-400 text-sm p-3 bg-[#2a3c57] rounded-lg">Carregando itens...</li>';
            
            try {
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) throw new Error('Falha ao carregar itens');
                
                const items = await response.json();
                ITEMS_LIST.innerHTML = ''; // Limpa a lista
                
                if (items.length === 0) {
                    ITEMS_LIST.innerHTML = '<li class="text-gray-400 text-sm p-3 bg-[#2a3c57] rounded-lg">Nenhum item de conhecimento cadastrado.</li>';
                    return;
                }

                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 bg-[#2a3c57] rounded-lg flex justify-between items-center flex-wrap';
                    
                    let contentInfo;
                    let actionButton = '';

                    if (item.tipoConteudo === 'TEXTO') {
                        // Exibe um resumo do texto
                        const resumo = item.texto ? item.texto.substring(0, 100).replace(/\n/g, ' ') + '...' : 'Sem conteúdo de texto.';
                        contentInfo = `<span class="text-sm text-gray-300 mt-1 md:mt-0 w-full md:w-auto">Tipo: ${item.tipoConteudo} | Resumo: ${resumo}</span>`;
                        actionButton = `<span class="text-sm text-yellow-500">Apenas visualização no chat</span>`;
                    } else {
                        // Para arquivos, exibe o nome do arquivo e o botão de download
                        // item.fileRef é o nome original do arquivo
                        contentInfo = `<span class="text-sm text-gray-300 mt-1 md:mt-0 w-full md:w-auto">Tipo: ${item.tipoConteudo} | Arquivo: ${item.fileRef}</span>`;
                        actionButton = `
                            <button onclick="downloadFile('${item._id}')" 
                                class="mt-2 md:mt-0 py-1 px-3 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded transition duration-200">
                                Download Arquivo
                            </button>
                        `;
                    }

                    listItem.innerHTML = `
                        <div class="w-full md:w-auto">
                            <p class="font-semibold text-white">${item.titulo} <span class="text-primary-blue text-xs ml-2">(${item.estado})</span></p>
                            ${contentInfo}
                        </div>
                        ${actionButton}
                    `;
                    ITEMS_LIST.appendChild(listItem);
                });

            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                showMessage('Erro ao carregar dados do servidor. Verifique o backend.', 'error');
                ITEMS_LIST.innerHTML = '';
            }
        }

        // Carrega os itens ao iniciar a página
        window.onload = loadKnowledgeItems;

    </script>
</body>

</html>
