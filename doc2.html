<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Itens de Conhecimento</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-blue-bg': '#0a192f', /* Mais escuro */
                        'card-bg': '#112240', /* Cartão mais claro */
                        'primary-blue': '#64ffda', /* Cor de destaque (neon/aqua) */
                        'input-bg': '#172a45', /* Cor de fundo do input */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .folder-toggle {
            transition: transform 0.2s;
        }
        .folder-closed .folder-toggle {
            transform: rotate(-90deg);
        }
    </style>
</head>

<body class="bg-dark-blue-bg text-gray-100 flex items-start justify-center p-4">

    <div class="w-full max-w-4xl bg-card-bg shadow-2xl p-8 md:p-10 rounded-xl space-y-8 mt-8 border border-primary-blue/20">
        
        <header class="flex justify-between items-center border-b border-primary-blue/30 pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white flex items-center">
                <i class="fas fa-list-ul text-primary-blue mr-3"></i>
                Itens de Conhecimento Salvos
            </h1>
            <a href="cadastro.html" class="py-2 px-4 text-primary-blue border border-primary-blue hover:bg-primary-blue/10 font-semibold rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-plus-circle mr-2"></i>
                Novo Cadastro
            </a>
        </header>

        <!-- Mensagens de Feedback (para erros de carregamento) -->
        <div id="messageBox" class="p-3 text-center rounded-lg hidden font-semibold text-sm border-2" role="alert"></div>

        <div id="items-list-container">
            <h2 class="text-xl font-bold text-gray-300 mb-4">Organização por Estado</h2>
            <div id="knowledge-items-list" class="space-y-4">
                <p class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Carregando itens...</p>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/documentacao';
        const ITEMS_LIST_CONTAINER = document.getElementById('knowledge-items-list');
        const MESSAGE_BOX = document.getElementById('messageBox');
        
        function showMessage(message, type = 'success') {
            MESSAGE_BOX.textContent = message;
            MESSAGE_BOX.classList.remove('hidden', 'bg-red-500/10', 'bg-green-500/10', 'text-red-400', 'text-green-400', 'border-red-500', 'border-green-500', 'bg-primary-blue/10', 'text-primary-blue', 'border-primary-blue');
            
            if (type === 'success') {
                MESSAGE_BOX.classList.add('bg-primary-blue/10', 'text-primary-blue', 'border', 'border-primary-blue');
            } else if (type === 'error') {
                MESSAGE_BOX.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500');
            }
        }

        window.downloadFile = function(itemId) {
            window.location.href = `${API_ENDPOINT}/download/${itemId}`;
        }
        
        // NOVO: Função para alternar a visibilidade da pasta
        window.toggleFolder = function(state) {
            const folderContent = document.getElementById(`folder-content-${state}`);
            const folderDiv = document.getElementById(`folder-${state}`);
            const icon = document.getElementById(`folder-icon-${state}`);
            
            if (folderContent.classList.contains('hidden')) {
                folderContent.classList.remove('hidden');
                folderDiv.classList.remove('folder-closed');
                icon.classList.replace('fa-folder-closed', 'fa-folder-open');
            } else {
                folderContent.classList.add('hidden');
                folderDiv.classList.add('folder-closed');
                icon.classList.replace('fa-folder-open', 'fa-folder-closed');
            }
        }

        // NOVO: Função para agrupar e renderizar os itens
        async function loadKnowledgeItems() {
            ITEMS_LIST_CONTAINER.innerHTML = '<p class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Carregando itens...</p>';
            
            try {
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) throw new Error('Falha ao carregar itens');
                
                const items = await response.json();
                ITEMS_LIST_CONTAINER.innerHTML = ''; 
                
                if (items.length === 0) {
                    ITEMS_LIST_CONTAINER.innerHTML = '<p class="text-gray-400 text-sm p-3 bg-input-bg rounded-lg">Nenhum item de conhecimento cadastrado.</p>';
                    return;
                }

                // 1. Agrupar os itens por Estado
                const groupedItems = items.reduce((acc, item) => {
                    const state = item.estado || 'GERAL'; // Usa 'GERAL' se o estado não for definido
                    if (!acc[state]) {
                        acc[state] = [];
                    }
                    acc[state].push(item);
                    return acc;
                }, {});

                // Ordenar os estados alfabeticamente
                const sortedStates = Object.keys(groupedItems).sort();

                // 2. Renderizar a lista de pastas (Accordions)
                sortedStates.forEach(state => {
                    const stateItems = groupedItems[state];
                    const folderDiv = document.createElement('div');
                    
                    // Inicialmente todos fechados (adiciona a classe 'folder-closed')
                    folderDiv.className = 'bg-input-bg rounded-lg shadow-md folder-closed transition-all'; 
                    folderDiv.id = `folder-${state}`;

                    const headerButton = document.createElement('button');
                    headerButton.className = 'w-full text-left p-4 flex justify-between items-center font-bold text-lg hover:bg-[#203a56] rounded-t-lg transition duration-200';
                    headerButton.onclick = () => toggleFolder(state);
                    
                    // Ícones e Título da Pasta
                    headerButton.innerHTML = `
                        <span class="flex items-center">
                            <i id="folder-toggle-${state}" class="fas fa-chevron-down mr-3 text-primary-blue folder-toggle"></i>
                            <i id="folder-icon-${state}" class="far fa-folder-closed mr-3 text-yellow-500"></i>
                            Pasta: ${state} <span class="text-sm ml-3 px-2 py-1 bg-primary-blue/20 text-primary-blue rounded-full">${stateItems.length} itens</span>
                        </span>
                    `;

                    const contentDiv = document.createElement('div');
                    contentDiv.id = `folder-content-${state}`;
                    contentDiv.className = 'hidden space-y-2 p-4 border-t border-gray-600/30';
                    
                    // 3. Renderizar os Documentos dentro da Pasta
                    stateItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-3 bg-card-bg rounded-lg flex justify-between items-center flex-wrap';

                        let contentInfo;
                        const isDownloadable = (item.tipoConteudo === 'TEXTO' || item.tipoConteudo === 'PDF' || item.tipoConteudo === 'HTML');
                        
                        // Lógica para Tipo de Conteúdo e Ícone
                        let iconClass;
                        if (item.tipoConteudo === 'TEXTO') {
                            iconClass = 'fas fa-terminal';
                            const resumo = item.texto ? item.texto.substring(0, 70).replace(/\n/g, ' ') + '...' : 'Sem conteúdo de texto.';
                            contentInfo = `<span class="text-sm text-gray-400 mt-1 md:mt-0 w-full md:w-auto flex items-center"><i class="${iconClass} mr-2 text-primary-blue/80"></i>${resumo}</span>`;
                        } else {
                            iconClass = item.tipoConteudo === 'PDF' ? 'fas fa-file-pdf' : 'fas fa-code';
                            const fileName = item.nomeArquivo || 'Nome Indisponível';
                            contentInfo = `<span class="text-sm text-gray-400 mt-1 md:mt-0 w-full md:w-auto flex items-center"><i class="${iconClass} mr-2 text-primary-blue/80"></i>Arquivo: ${fileName}</span>`;
                        }
                        
                        let actionButton = '';
                        if (isDownloadable) {
                            actionButton = `
                                <button onclick="downloadFile('${item._id}')" 
                                    class="mt-2 md:mt-0 py-1 px-3 bg-primary-blue hover:bg-green-600 text-dark-blue-bg text-xs font-bold rounded transition duration-200 flex items-center shadow-md">
                                    <i class="fas fa-download mr-1"></i> Download
                                </button>
                            `;
                        }

                        itemDiv.innerHTML = `
                            <div class="w-full md:w-auto flex-grow">
                                <p class="font-semibold text-white">${item.titulo}</p>
                                ${contentInfo}
                            </div>
                            ${actionButton}
                        `;
                        contentDiv.appendChild(itemDiv);
                    });

                    folderDiv.appendChild(headerButton);
                    folderDiv.appendChild(contentDiv);
                    ITEMS_LIST_CONTAINER.appendChild(folderDiv);
                });

            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                showMessage('Erro ao carregar dados do servidor. Verifique o backend.', 'error');
                ITEMS_LIST_CONTAINER.innerHTML = '';
            }
        }

        // Carrega os itens ao iniciar a página
        window.onload = loadKnowledgeItems;

    </script>
</body>

</html>
