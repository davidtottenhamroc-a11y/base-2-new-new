<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base para N2 - VSoft</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Obt√©m o estado de login do localStorage
        const AGENTE_LOGADO = localStorage.getItem('agenteLogado'); 
        const IS_LOGGED_IN = localStorage.getItem('isLoggedIn');

        // Se o login ou a flag n√£o estiverem presentes/v√°lidos, redireciona para a p√°gina de login
        if (AGENTE_LOGADO === null || IS_LOGGED_IN !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        /* Estilos Globais */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0d1a2a;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        /* Estilos Header, Grid e Logout (Mantidos) */
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo {
            font-size: 40px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .description {
            font-size: 16px;
            opacity: 0.9;
        }

        main {
            padding: 20px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .menu-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 120px;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .card-icon {
            font-size: 35px;
            color: #3498db;
            margin-bottom: 10px;
        }

        .card-icon img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-description {
            font-size: 13px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        .logout-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 16px;
            background: linear-gradient(135deg, #dc3545, #b42a35);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-button:hover {
            background: linear-gradient(135deg, #c82333, #a71d24);
        }

        /* --- Estilos Comuns do Chatbot --- */
        #chat-widget-container, #ai-chat-widget-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw; 
            height: 100vh;
            background: rgba(13, 26, 42, 0.95); 
            border-radius: 0;
            box-shadow: none;
            display: none; 
            z-index: 9999;
            align-items: center; 
            justify-content: center;
        }

        .chat-content {
            width: 90%;
            max-width: 900px; 
            height: 90%;
            max-height: 820px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Adapta√ß√£o para headers dos chats */
        #chat-header, #ai-chat-header {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #ai-chat-header {
            background: #e67e22; /* Cor diferente para o chat IA */
        }
        
        #chat-header i, #ai-chat-header i { margin-right: 10px; }
        
        #chat-close-btn, #ai-chat-close-btn {
            background: none;
            border: 1px solid white; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #chat-close-btn:hover { background: #2980b9; }
        #ai-chat-close-btn:hover { background: #d35400; }

        #chat-body, #ai-chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 15px;
        }
        
        #chat-messages, #ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa; 
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        /* Estiliza√ß√£o das Mensagens Aprimorada (Aplicada a ambos) */
        .message {
            max-width: 90%; 
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
        }
        .user-message {
            background: #3498db;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px; 
        }
        .bot-message {
            background: #e9ecef; 
            color: #333;
            align-self: flex-start;
            margin-right: auto;
            border: none;
            border-bottom-left-radius: 5px; 
            white-space: pre-wrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .bot-message strong { color: #c0392b; }
        .bot-message pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.3;
        }

        #chat-input-container, #ai-chat-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-top: 1px solid #ddd;
        }
        
        #estado-filter, #ai-estado-filter {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 120px;
            background: white;
        }
        
        #chat-input, #ai-chat-input {
            flex-grow: 1;
            padding: 12px 20px;
            border: 1px solid #ccc;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        #chat-input:focus, #ai-chat-input:focus { border-color: #3498db; outline: none; }
        
        #chat-send-btn, #ai-chat-send-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s, transform 0.1s;
        }
        #chat-send-btn:hover, #ai-chat-send-btn:hover { background: #218838; }
        #chat-send-btn:active, #ai-chat-send-btn:active { transform: scale(0.95); }

        .chat-button {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            margin-top: 8px;
            transition: background 0.2s;
            display: inline-block; 
        }
        .chat-button:hover:not(:disabled) { background: #2980b9; }
        .chat-button:disabled { background: #ccc; cursor: not-allowed; }

        .typing-indicator {
            background: #e0e0e0;
            color: #555;
            padding: 8px 15px;
            border-radius: 20px;
            font-style: italic;
            display: inline-block;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Estilo dos Bot√µes Flutuantes (Adaptado) --- */
        #chat-open-btn {
            position: fixed;
            bottom: 30px;
            right: 30px; /* Posi√ß√£o original */
            padding: 15px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
        }
        #chat-open-btn i { margin-right: 8px; }

        /* NOVO ESTILO para o bot√£o da IA */
        #chat-open-ai-btn {
            position: fixed;
            bottom: 30px;
            right: 210px; /* Deslocado para a esquerda para caber ao lado do outro bot√£o */
            padding: 15px 20px;
            background: #e67e22; /* Laranja para destacar a IA */
            color: white;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
        }
        #chat-open-ai-btn i { margin-right: 8px; }

        mark { background: #ffe58a; padding: 0 3px; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">VSoft</div>
            <h1>Base para N2</h1>
            <p class="description">Central de guias e documenta√ß√µes t√©cnicas por estado.</p>
        </header>

        <main>
                <div class="menu-grid">
                    <a href="menu_rn.html" class="menu-card">
                <div class="card-icon">
                    <img src="img/RN.jpeg" alt="√çcone RN">
                </div>
                <div>
                    <h2 class="card-title">RN</h2>
                    <p class="card-description">Rio Grande do Norte</p>
                </div>
                </a>
                <a href="menu_df.html" class="menu-card">
                    <div class="card-icon"><img src="img/DF.jpeg" alt="√çcone DF"></div>
                    <div>
                        <h2 class="card-title">DF</h2>
                        <p class="card-description">Distrito Federal</p>
                    </div>
                </a>
                <a href="menu_se.html" class="menu-card">
                    <div class="card-icon"><img src="img/SE.jpeg" alt="√çcone SE"></div>
                    <div>
                        <h2 class="card-title">SE</h2>
                        <p class="card-description">Sergipe</p>
                    </div>
                </a>
                <a href="menu_ms.html" class="menu-card">
                    <div class="card-icon"><img src="img/fMS.jpeg" alt="√çcone MS"></div>
                    <div>
                        <h2 class="card-title">MS</h2>
                        <p class="card-description">Mato Grosso do Sul</p>
                    </div>
                </a>
                <a href="menu_pe.html" class="menu-card">
                    <div class="card-icon"><img src="img/PE.jpeg" alt="√çcone PE"></div>
                    <div>
                        <h2 class="card-title">PE</h2>
                        <p class="card-description">Pernambuco</p>
                    </div>
                </a>
                <a href="menu_pb.html" class="menu-card">
                    <div class="card-icon"><img src="img/PB.jpeg" alt="√çcone PB"></div>
                    <div>
                        <h2 class="card-title">PB</h2>
                        <p class="card-description">Para√≠ba</p>
                    </div>
                </a>
                <a href="menu_ba.html" class="menu-card">
                    <div class="card-icon"><img src="img/BA.jpg" alt="√çcone BA"></div>
                    <div>
                        <h2 class="card-title">BA</h2>
                        <p class="card-description">Bahia</p>
                    </div>
                </a>
                <a href="menu_mg.html" class="menu-card">
                    <div class="card-icon"><img src="img/MG.jpg" alt="√çcone MG"></div>
                    <div>
                        <h2 class="card-title">MG</h2>
                        <p class="card-description">Minas Gerais</p>
                    </div>
                </a>
                <a href="menu_go.html" class="menu-card">
                    <div class="card-icon"><img src="img/GO.jpeg" alt="√çcone GO"></div>
                    <div>
                        <h2 class="card-title">GO</h2>
                        <p class="card-description">Goi√°s</p>
                    </div>
                </a>
                <a href="menu_ma.html" class="menu-card">
                    <div class="card-icon"><img src="img/MA.jpg" alt="√çcone MA"></div>
                    <div>
                        <h2 class="card-title">MA</h2>
                        <p class="card-description">Maranh√£o</p>
                    </div>
                </a>
                <a href="menu_al.html" class="menu-card">
                    <div class="card-icon"><img src="img/AL.jpeg" alt="√çcone AL"></div>
                    <div>
                        <h2 class="card-title">AL</h2>
                        <p class="card-description">Alagoas</p>
                    </div>
                </a>
                <a href="menu_ce.html" class="menu-card">
                    <div class="card-icon"><img src="img/CE.png" alt="√çcone CE"></div>
                    <div>
                        <h2 class="card-title">CE</h2>
                        <p class="card-description">Cear√°</p>
                    </div>
                </a>
                <a href="menu_geral.html" class="menu-card" style="background: #e6f7ff; border-color: #3498db;">
                    <div class="card-icon"><i class="fas fa-cogs" style="color: #2980b9;"></i></div>
                    <div>
                        <h2 class="card-title">Geral / Admin</h2>
                        <p class="card-description">Pol√≠ticas, Base de Conhecimento e Registro Di√°rio</p>
                    </div>
                </a>
                <a href="login_n2.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-database"></i></div>
                    <div>
                        <h2 class="card-title">Gerenciar Base de Conhecimento</h2>
                        <p class="card-description">Interface para adicionar e atualizar informa√ß√µes do chatbot por estado (MongoDB).</p>
                    </div>
                </a>
                    <a href="menu_doc.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-database"></i></div>
                    <div>
                        <h2 class="card-title">DOC</h2>
                        <p class="card-description">Interface para amarzenamento de documeta√ß√µes internas.</p>
                    </div>
                </a> 	
                </div>
        </main>
        <button class="logout-button" onclick="logout()">Sair</button>
    </div>
    
    <div id="chat-widget-container">
        <div class="chat-content">
            <div id="chat-header">
                <div style="display:flex;align-items:center;gap:8px;"><i class="fas fa-robot"></i> Assistente VSoft N2</div>
                <button id="chat-close-btn" onclick="toggleChat()">X</button>
            </div>
            <div id="chat-body">
                <div id="chat-messages">
                    <div class="message bot-message">
                        Ol√°! Sou seu assistente de suporte N2. Minha base de conhecimento √© totalmente gerenciada pelo <strong>MongoDB</strong>.<br><br>
                        Use o filtro de estado e escreva sua d√∫vida. Por exemplo: <em>"SE ve√≠culos"</em> ou escolha o estado no dropdown.
                    </div>
                </div>
                <div id="chat-input-container">
                    <select id="estado-filter">
                        <option value="">Todos os estados</option>
                        <option value="RN">RN</option>
                        <option value="SE">SE</option>
                        <option value="MS">MS</option>
                        <option value="DF">DF</option>
                        <option value="PE">PE</option>
                        <option value="PB">PB</option>
                        <option value="BA">BA</option>
                        <option value="MG">MG</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="AL">AL</option>
                        <option value="CE">CE</option>
                        <option value="TODOS">TODOS</option>
                    </select>
                    <input type="text" id="chat-input" placeholder="Ex: 'N2 de RN', 'SLA cr√≠tico' ou 'Consulta CFC DF'">
                    <button id="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div id="ai-chat-widget-container">
        <div class="chat-content">
            <div id="ai-chat-header">
                <div style="display:flex;align-items:center;gap:8px;"><i class="fas fa-brain"></i> Assistente IA Avan√ßado (n8n)</div>
                <button id="ai-chat-close-btn" onclick="toggleAIChat()">X</button>
            </div>
            <div id="ai-chat-body">
                <div id="ai-chat-messages">
                    <div class="message bot-message">
                        Ol√°! Eu sou o assistente avan√ßado alimentado pelo **n8n**. Eu busco informa√ß√µes em **toda a documenta√ß√£o (incluindo PDFs/HTML)** armazenada no DOC!
                    </div>
                </div>
                <div id="ai-chat-input-container">
                    <select id="ai-estado-filter">
                        <option value="">Todos os estados</option>
                        <option value="RN">RN</option>
                        <option value="SE">SE</option>
                        <option value="MS">MS</option>
                        <option value="DF">DF</option>
                        <option value="PE">PE</option>
                        <option value="PB">PB</option>
                        <option value="BA">BA</option>
                        <option value="MG">MG</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="AL">AL</option>
                        <option value="CE">CE</option>
                        <option value="TODOS">TODOS</option>
                    </select>
                    <input type="text" id="ai-chat-input" placeholder="Pergunte sobre qualquer documento ou procedimento...">
                    <button id="ai-chat-send-btn" onclick="sendAIMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    <button id="chat-open-btn" onclick="toggleChat()"><i class="fas fa-comment-dots"></i> Chat N2</button>
    <button id="chat-open-ai-btn" onclick="toggleAIChat()"><i class="fas fa-brain"></i> IA Avan√ßada</button>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

    <script>
        // --- CONFIGURA√á√ïES DE URL E ESTADOS ---
        const BACKEND_URL = 'https://base-2-new-new-9xow.vercel.app';
        const N8N_AI_WEBHOOK_URL = 'https://basen2.app.n8n.cloud/webhook/ai-query'; // Seu Webhook n8n

        const VALID_STATES = ['RN', 'DF', 'SE', 'MS', 'PE', 'PB', 'BA', 'MG', 'GO', 'MA', 'AL', 'CE', 'TODOS'];

        // --- Vari√°veis e L√≥gica do Chat CL√ÅSSICO (Mantidas) ---
        let chatMemories = [];
        const SYNONYM_MAP = {
            'endpoint': ['api', 'servico', 'url', 'acesso', 'integracao'],
            'sla': ['prazo', 'tempo', 'critico', 'atendimento'],
            'cfc': ['autoescola', 'credenciada', 'centro'],
            'fluxo': ['procedimento', 'passos', 'guia', 'rotina', 'etapa'],
            'job': ['servico', 'tarefa', 'rotina', 'processo'],
            'incidentes': ['problema', 'erro', 'falha', 'indisponibilidade'],
            'consulta': ['pesquisa', 'buscar', 'verificar'],
            'veiculos': ['ve√≠culo', 'carro', 'automovel', 'placa'],
            'aula': ['aulas', 'licao', 'li√ß√£o', 'pratica', 'pr√°tica']
        };
        const STOP_WORDS_PT = [
            'a', 'o', 'as', 'os', 'um', 'uma', 'uns', 'umas', 'de', 'do', 'da', 'dos', 'das', 'e', '√©', 'ou',
            'para', 'com', 'sem', 'em', 'por', 'sobre', 'sob', 'at√©', 'ao', 'aos', '√†', '√†s',
            'que', 'qual', 'quais', 'quem', 'onde', 'como', 'quando', 'porque', 'porqu√™', 'pra', 'pela', 'pelo',
            'dele', 'dela', 'neste', 'nesta', 'isso', 'este', 'esta', 'ser', 'meu', 'minha', 'meus', 'minhas',
            'oii', 'oi', 'ola', 'bom', 'dia', 'tarde', 'noite', 'sobre', 'me', 'meu', 'queria', 'gostaria'
        ];

        let fuse = null;
        let memoriesIndex = []; 
        let lastResults = []; 
        let resultsPage = 0;
        const PAGE_SIZE = 3;
        let lastQueryKeywords = [];
        
        // Fun√ß√µes de login, toggleChat e helpers (normalize, expandTerms, highlight)
        function logout() {
            localStorage.removeItem('agenteSelecionado');
            localStorage.removeItem('estadoSelecionado');
            localStorage.removeItem('agenteLogado');
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'login.html';
        }

        function toggleChat() {
            const chatWidget = document.getElementById('chat-widget-container');
            const openBtn = document.getElementById('chat-open-btn');

            if (chatWidget.style.display === 'flex') {
                chatWidget.style.display = 'none';
                openBtn.style.display = 'block';
                document.body.style.overflow = (document.getElementById('ai-chat-widget-container').style.display === 'flex') ? 'hidden' : 'auto';
            } else {
                chatWidget.style.display = 'flex';
                openBtn.style.display = 'none';
                document.body.style.overflow = 'hidden';
                document.getElementById('chat-input').focus();
            }
        }
        
        function normalizeText(t) {
            return (t || '')
                .normalize('NFD').replace(/[ÃÄ-\u036f]/g, '')
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function expandTerms(terms) {
            const expanded = new Set();
            const stateTokens = VALID_STATES.map(s => s.toLowerCase());
            for (const t of terms) {
                expanded.add(t);
                if (!stateTokens.includes(t)) {
                    const mapped = SYNONYM_MAP[t];
                    if (mapped) mapped.forEach(s => expanded.add(s));
                }
            }
            return Array.from(expanded);
        }

        function highlight(text, terms) {
            let out = text || '';
            for (const term of terms) {
                if (!term || term.length < 2) continue;
                const safe = term.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
                out = out.replace(new RegExp(`(${safe})`, 'ig'), '<mark>$1</mark>');
            }
            return out;
        }

        // Fun√ß√µes de carregamento de mem√≥ria, send/append message, e getBotResponse (CL√ÅSSICO)
        
        async function loadMemoriesFromDatabase() {
            console.log(`Tentando carregar mem√≥rias de: ${BACKEND_URL}/api/memories`);
            try {
                const response = await fetch(`${BACKEND_URL}/api/memories`);
                if (response.ok) {
                    const data = await response.json();
                    chatMemories = data;
                    memoriesIndex = data.map(m => ({
                        ...m,
                        titulo: (m.texto || '').split(':')[0] || '',
                        texto: m.texto || '',
                        texto_normalizado: normalizeText(m.texto || ''),
                        estado: (m.estado || 'TODOS').toUpperCase()
                    }));

                    const options = {
                        includeScore: true,
                        shouldSort: true,
                        threshold: 0.4, 
                        keys: [
                            { name: 'titulo', weight: 0.7 },
                            { name: 'texto', weight: 0.25 },
                            { name: 'estado', weight: 0.05 }
                        ],
                        ignoreLocation: true,
                        useExtendedSearch: true
                    };
                    fuse = new Fuse(memoriesIndex, options);
                    console.log(`[MongoDB] ${memoriesIndex.length} mem√≥rias indexadas com Fuse.`);
                } else {
                    appendMessage(`[ERRO ${response.status}] A API retornou um status de erro. O backend Vercel pode estar inativo ou ter falhado ao conectar ao MongoDB.`, 'bot-message');
                }
            } catch (error) {
                console.error('Erro de rede/conex√£o:', error);
                appendMessage(`[ERRO DE CONEX√ÉO] N√£o foi poss√≠vel acessar o backend Vercel em **${BACKEND_URL}**. Verifique se a URL est√° correta e se o projeto est√° implantado e ativo.`, 'bot-message');
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMemoriesFromDatabase();
            document.getElementById('chat-open-btn').style.display = 'block';
            document.getElementById('chat-open-ai-btn').style.display = 'block'; // Mostra os dois bot√µes
        });

        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (messageText === '') return;
            appendMessage(messageText, 'user-message');

            const userMessageForSearch = messageText;
            input.value = '';
            showTypingIndicator();
            
            setTimeout(() => {
                const botResponse = getBotResponse(userMessageForSearch);
                appendMessage(botResponse, 'bot-message');
                hideTypeningIndicator();
            }, 600);
        }

        function appendMessage(text, className) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;

            const codeBlockRegex = /(```json|```|\{)\n?([\s\S]*?)(\n?```|\n\})/g;
            let processedText = text.replace(codeBlockRegex, (match, openTag, content, closeTag) => {
                content = content.replace(/```json|```|{|}/g, '').trim();
                return `\n<pre>${content}</pre>\n`;
            });

            processedText = processedText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.innerHTML = processedText;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = 'Digitando...';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
        }

        function hideTypeningIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
            document.getElementById('chat-input').focus();
        }

        function getBotResponse(message) {
            const estadoFilter = (document.getElementById('estado-filter')?.value || '').toUpperCase();
            const raw = message.trim();
            const normalized = normalizeText(raw);

            const stateTokens = VALID_STATES.map(s => s.toLowerCase());
            const possibleState = normalized.split(/\s+/).find(w => stateTokens.includes(w));
            const effectiveState = (estadoFilter || (possibleState ? possibleState.toUpperCase() : '')).toUpperCase();

            let keywords = normalized.split(/\s+/).filter(w => w.length > 1 && !STOP_WORDS_PT.includes(w));
            
            keywords = expandTerms(keywords);
            lastQueryKeywords = keywords.slice();

            let pool = memoriesIndex;
            if (effectiveState && effectiveState !== 'TODOS') {
                pool = memoriesIndex.filter(m => (m.estado || '').toUpperCase() === effectiveState);
            }

            if (keywords.length === 0) {
                const list = pool.sort((a,b) => new Date(b.dataHora) - new Date(a.dataHora)).slice(0, 6);
                if (list.length === 0) return `N√£o encontrei mem√≥rias para o estado ${effectiveState || 'TODOS'}. Use 'Gerenciar Base de Conhecimento' para inserir.`;
                lastResults = list;
                resultsPage = 0;
                return formatResultsPage();
            }

            let results = pool.filter(memory => {
                const memoryText = normalizeText(memory.texto || '');
                const memoryTitle = normalizeText(memory.titulo || '');
                
                return keywords.some(keyword => 
                    memoryText.includes(keyword) || memoryTitle.includes(keyword)
                );
            });

            if (results.length === 0 && fuse) {
                try {
                    const tempFuse = new Fuse(pool, { 
                        includeScore: true, 
                        threshold: 0.5,
                        keys: ['titulo', 'texto'], 
                        ignoreLocation: true 
                    });
                    
                    const fuseResults = tempFuse.search(keywords.join(' '), { limit: 20 });
                    results = fuseResults.map(r => ({ ...r.item, __fuseScore: r.score }));
                } catch (e) {
                    console.log('Fuse search failed, using fallback');
                }
            }

            results = results.map(memory => {
                let score = 0;
                const memoryText = normalizeText(memory.texto || '');
                const memoryTitle = normalizeText(memory.titulo || '');
                
                keywords.forEach(keyword => {
                    if (memoryTitle.includes(keyword)) score += 3;
                    if (memoryText.includes(keyword)) score += 1; 
                });
                
                if (effectiveState && memory.estado === effectiveState) score += 2;
                
                const allKeywordsMatch = keywords.every(keyword => 
                    memoryText.includes(keyword) || memoryTitle.includes(keyword)
                );
                if (allKeywordsMatch) score += 5;
                
                return { ...memory, _score: score };
            }).sort((a, b) => b._score - a._score);

            if (results.length === 0) {
                return `Desculpe, n√£o encontrei uma resposta na base de conhecimento (MongoDB) para "${raw}" no estado ${effectiveState || 'TODOS'}. Tente termos diferentes ou v√° em 'Gerenciar Base de Conhecimento'.`;
            }

            lastResults = results;
            resultsPage = 0;
            return formatResultsPage();
        }

        function formatResultsPage() {
            const start = resultsPage * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const page = lastResults.slice(start, end);
            if (page.length === 0) return 'Nenhum resultado nesta p√°gina.';

            const total = lastResults.length;
            const listFormatted = page.map(m => {
                const date = m.dataHora ? new Date(m.dataHora).toLocaleDateString('pt-BR') : '';
                const parts = (m.texto || '').split(':');
                const title = parts[0] || m.titulo || 'Sem t√≠tulo';
                const content = parts.length > 1 ? parts.slice(1).join(':') : m.texto || '';
                const keywordsFromQuery = lastQueryKeywords || [];
                const highlighted = highlight(content, keywordsFromQuery);
                const img = m.imagemUrl ? `<br><img src="${m.imagemUrl}" style="max-width:100%;border-radius:6px;margin-top:8px;">` : '';
                const id = m._id || m.id || (m.idMemoria || '') || '';
                const actions = `<br><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button class="chat-button" onclick="showFullMemory('${id}')">Ver Mais</button><button class="chat-button" onclick="sendFeedback('${id}', true)">üëç</button><button class="chat-button" onclick="sendFeedback('${id}', false)">üëé</button></div>`;
                return `**[${m.estado || 'TODOS'}] ${title}**\n\n${highlighted} (Agente: ${m.agente || '‚Äî'}, ${date})${img}${actions}`;
            }).join('\n\n---\n\n');

            const remaining = Math.max(0, total - ((resultsPage + 1) * PAGE_SIZE));
            const moreBtn = remaining > 0 ? `\n\n<button class="chat-button" onclick="showMoreResults()">Mostrar mais (${remaining} restantes)</button>` : '\n\n*Fim da lista.*';
            return `Encontrei **${total}** refer√™ncias.\n\n${listFormatted}${moreBtn}`;
        }

        function showMoreResults() {
            resultsPage += 1;
            appendMessage(formatResultsPage(), 'bot-message');
        }

        function showFullMemory(id) {
            const mem = memoriesIndex.find(m => (m._id === id || m.id === id || (m.idMemoria === id)));
            if (!mem) { appendMessage('Conte√∫do n√£o encontrado', 'bot-message'); return; }
            appendMessage(`**${mem.titulo}**\n\n${mem.texto}\n\n(Agente: ${mem.agente}, ${new Date(mem.dataHora).toLocaleString('pt-BR')})`, 'bot-message');
        }

        async function sendFeedback(id, positive) {
            if (!id) { appendMessage('ID da mem√≥ria inv√°lido para feedback.', 'bot-message'); return; }
            try {
                await fetch(`${BACKEND_URL}/api/memories/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, positive })
                });
                appendMessage(positive ? 'Obrigado pelo feedback positivo!' : 'Obrigado, registramos o feedback e iremos revisar.', 'bot-message');
            } catch (e) {
                appendMessage('Erro ao enviar feedback.', 'bot-message');
            }
        }
        
        // --- FIM L√ìGICA DO CHAT CL√ÅSSICO ---


        // ----------------------------------------
        // --- L√ìGICA DO NOVO CHATBOT IA (n8n) ---
        // ----------------------------------------

        function toggleAIChat() {
            const chatWidget = document.getElementById('ai-chat-widget-container');
            const openBtn = document.getElementById('chat-open-ai-btn');

            if (chatWidget.style.display === 'flex') {
                chatWidget.style.display = 'none';
                openBtn.style.display = 'block';
                // Garante que o scroll do corpo volte ao normal se o outro chat tamb√©m estiver fechado
                if (document.getElementById('chat-widget-container').style.display !== 'flex') {
                    document.body.style.overflow = 'auto';
                }
            } else {
                chatWidget.style.display = 'flex';
                openBtn.style.display = 'none';
                document.body.style.overflow = 'hidden';
                document.getElementById('ai-chat-input').focus();
            }
        }

        document.getElementById('ai-chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendAIMessage();
        });

        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const messageText = input.value.trim();

            if (messageText === '') return;

            // 1. Mostrar a mensagem do usu√°rio
            appendMessageToAI(messageText, 'user-message');
            input.value = '';
            
            // 2. Mostrar indicador e desabilitar input
            showAITypingIndicator();

            const estadoFilter = (document.getElementById('ai-estado-filter')?.value || '').toUpperCase();
            const agente = localStorage.getItem('agenteLogado') || 'desconhecido';
            
            try {
                const response = await fetch(N8N_AI_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // CORRE√á√ÉO DE SEGURAN√áA: Adiciona o header de autentica√ß√£o
                        'X-Custom-Secret': 'Tottenham0724' 
                    },
                    body: JSON.stringify({
                        query: messageText,
                        estado: estadoFilter,
                        user: agente
                    })
                });

                // TENTAR LER A RESPOSTA JSON DE VOLTA:
                if (response.ok) {
                    const data = await response.json();
                    const botResponse = data.response || "A busca retornou um resultado vazio. Tente refinar a pergunta.";
                    appendMessageToAI(botResponse, 'bot-message');
                } else {
                    // Se o n8n retornar um status de erro (4xx, 5xx), pode ser falha de AUTH
                    const errorText = await response.text();
                    if (response.status === 401 || response.status === 403) {
                         appendMessageToAI(`[ERRO DE AUTENTICA√á√ÉO üîë] O acesso ao n8n foi negado. Verifique se o header 'X-Custom-Secret' est√° configurado corretamente no Webhook.`, 'bot-message');
                    } else {
                         appendMessageToAI(`[ERRO N8N] O fluxo retornou um erro (Status: ${response.status}). Verifique as execu√ß√µes no n8n.`, 'bot-message');
                    }
                    console.error('N8N Error:', errorText);
                }

            } catch (error) {
                // Se houver falha de rede/JSON (o que acontecia com o CORS)
                console.error('Erro ao chamar webhook n8n:', error);
                appendMessageToAI(`[ERRO DE CONEX√ÉO] Falha na rede. O n8n Cloud pode ter bloqueado a requisi√ß√£o novamente.`, 'bot-message');
            } finally {
                hideAITypeningIndicator();
            }
        }

        function appendMessageToAI(text, className) {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            
            // Reutilizando a l√≥gica de formata√ß√£o de texto
            const codeBlockRegex = /(```json|```|\{)\n?([\s\S]*?)(\n?```|\n\})/g;
            let processedText = text.replace(codeBlockRegex, (match, openTag, content, closeTag) => {
                content = content.replace(/```json|```|{|}/g, '').trim();
                return `\n<pre>${content}</pre>\n`;
            });
            processedText = processedText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            messageDiv.innerHTML = processedText;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showAITypingIndicator() {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'ai-typing-indicator';
            typingDiv.innerHTML = 'n8n est√° processando documentos...';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            document.getElementById('ai-chat-input').disabled = true;
            document.getElementById('ai-chat-send-btn').disabled = true;
        }

        function hideAITypeningIndicator() {
            const typingIndicator = document.getElementById('ai-typing-indicator');
            if (typingIndicator) typingIndicator.remove();
            document.getElementById('ai-chat-input').disabled = false;
            document.getElementById('ai-chat-send-btn').disabled = false;
            document.getElementById('ai-chat-input').focus();
        }
        
        // ----------------------------------------------------------------------------------
        // --- C√ìDIGO DO N√ì CODE IN JAVASCRIPT (Deve ser copiado para o n8n) ---
        // ----------------------------------------------------------------------------------

        /*
        
        // Este √© o c√≥digo que deve ser COLADO no n√≥ Code in JavaScript do n8n (no modo 'Run Once for All Items').

        // Acessa a lista completa de itens de input
        const allItems = $input.all();

        // Acessa a consulta do Webhook (Assumindo que o Merge coloca a query no primeiro item)
        // Usamos .all()[0] para acessar o primeiro item da cole√ß√£o no modo 'Run Once for All Items'
        const webhookData = allItems[0]?.json?.body || {};
        const rawQuery = webhookData.query || '';
        const estadoFilter = (webhookData.estado || '').toUpperCase();
        let responseMessage = '';

        // 1. Unificar TODAS as Fontes de Dados (Desempacotando os 3 inputs do Merge)
        let documentPool = [];

        // Fun√ß√µes utilit√°rias para desempacotar
        const getJsonData = (inputItem) => {
            if (!inputItem || !inputItem.json) return [];
            
            // Se for um Array (comum em n√≥s HTTP)
            if (Array.isArray(inputItem.json)) {
                return inputItem.json;
            }
            
            // Se for um Objeto (comum em Webhooks), pode ser necess√°rio ajust√°-lo
            return [inputItem.json];
        };

        // --- Itera sobre todos os itens de Input (incluindo Webhook, APIs e Cache) ---
        for (let i = 0; i < allItems.length; i++) {
            const item = allItems[i];
            
            // Tentativa de ler JSON do item (funciona para HTTP Request e para o Webhook)
            documentPool.push(...getJsonData(item));

            // Tratamento espec√≠fico para o Cache HTML BIN√ÅRIO do Read File
            if (item.binary && item.binary.conteudo) { // Verifica a propriedade bin√°ria 'conteudo'
                try {
                    // O bin√°rio do 'Convert to File' deve ser lido
                    const htmlJsonBuffer = item.binary.conteudo; 
                    const htmlJsonString = htmlJsonBuffer.toString('utf8');
                    const htmlData = JSON.parse(htmlJsonString);
                    
                    // Adiciona o conte√∫do do arquivo
                    if (Array.isArray(htmlData)) {
                        documentPool.push(...htmlData);
                    } else if (typeof htmlData === 'object' && htmlData !== null) {
                        documentPool.push(htmlData);
                    }

                } catch (e) {
                    console.error("Erro ao ler ou parsear o cache HTML bin√°rio:", e);
                }
            }
        }


        // 2. Valida√ß√£o e Pr√©-processamento
        if (documentPool.length === 0) {
            responseMessage = "ERRO: Base de conhecimento vazia. Verifique se o cache HTML foi lido corretamente e se as APIs (Docs/Memories) retornaram dados.";
            return [{ json: { response: responseMessage } }];
        }

        if (!rawQuery) {
            responseMessage = "Por favor, forne√ßa uma consulta (query) para que eu possa pesquisar.";
            return [{ json: { response: responseMessage } }];
        }

        // Normaliza√ß√£o da consulta e extra√ß√£o de palavras-chave
        const normalizedQuery = rawQuery.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
        // CORRE√á√ÉO DE BUSCA: Permite palavras com 2 ou mais caracteres (ex: RN, DF, Web, Job)
        const keywords = normalizedQuery.split(/\s+/).filter(w => w.length >= 2); 

        // 3. Execu√ß√£o da Busca, Filtro e Pontua√ß√£o (Relev√¢ncia)
        const MAX_RESULTS = 7;
        let matchingResults = documentPool.map(doc => {
            let score = 0;
            const searchField = ((doc.titulo || '') + ' ' + (doc.texto || '')).normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
            const docEstado = (doc.estado || 'TODOS').toUpperCase();

            // Filtro Imediato por Estado
            if (estadoFilter && estadoFilter !== 'TODOS' && docEstado !== estadoFilter) {
                return null;
            }

            // Pontua√ß√£o por Palavras-Chave
            if (keywords.length > 0) {
                keywords.forEach(keyword => {
                    if (doc.titulo && doc.titulo.toLowerCase().includes(keyword)) score += 5;
                    if (searchField.includes(keyword)) score += 2;
                });
                
                const allKeywordsMatch = keywords.every(keyword => searchField.includes(keyword));
                if (allKeywordsMatch) score += 10;
            }
            
            if (score === 0) return null;

            return { ...doc, _score: score };
        }).filter(doc => doc !== null)
        .sort((a, b) => b._score - a._score);


        // 4. Formata√ß√£o dos Resultados (Mensagem Final)
        if (matchingResults.length === 0) {
            responseMessage = `Desculpe, n√£o encontrei refer√™ncias relevantes para "${rawQuery}" no estado ${estadoFilter || 'TODOS'} em nenhuma das fontes.`;
        } else {
            // Limita e formata os MAX_RESULTS
            const formattedList = matchingResults.slice(0, MAX_RESULTS).map((doc, index) => {
                const title = doc.titulo || 'Trecho sem T√≠tulo';
                const contentPreview = (doc.texto || 'Conte√∫do indispon√≠vel.').substring(0, 150) + '...';
                const source = doc.fonte || (doc.agente ? 'Mem√≥ria' : 'Cache Local');
                
                return `**${index + 1}. [${doc.estado || 'TODOS'}] ${title}**\n${contentPreview} (Fonte: ${source})`;
            }).join('\n\n---\n\n');

            const total = matchingResults.length;
            responseMessage = `Encontrei **${total}** refer√™ncias relevantes. As ${Math.min(MAX_RESULTS, total)} principais s√£o:\n\n${formattedList}`;
        }

        // 5. Retorna o Objeto para o N√≥ Respond to Webhook
        return [{ 
            json: { 
                response: responseMessage 
            } 
        }];
        
        */
        // ----------------------------------------------------------------------------------

    </script>
</body>
</html>
